<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BASTIKWANG TV</title>

  <!-- Tailwind & Font Awesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- JWPlayer -->
  <script src="jwpsrv.js"></script>
  <script src="jwplayer.js"></script>
</head>

<body class="bg-black text-white min-h-screen flex flex-col relative overflow-hidden">

  <main class="flex-grow p-4">
    <div class="w-full max-w-4xl mx-auto bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-8">
      <div id="player" class="w-full aspect-video"></div>
    </div>
  </main>

  <!-- Floating TV Icon -->
  <button id="channelToggle"
    class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-lg transition-transform duration-300 focus:outline-none">
    <i class="fas fa-tv text-2xl"></i>
  </button>

  <!-- Channel Sidebar -->
  <div id="channelSidebar"
    class="fixed top-0 right-0 h-full w-80 bg-gray-900 transform translate-x-full transition-transform duration-300 z-50 shadow-2xl">
    
    <div class="p-4 border-b border-gray-700 flex justify-between items-center">
      <h2 class="text-lg font-bold">üì∫ Channels</h2>
      <button id="closeSidebar" class="text-gray-400 hover:text-white text-xl">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Search Bar -->
    <div class="p-3 border-b border-gray-700 sticky top-0 bg-gray-900 z-10">
      <input id="searchInput" type="text" placeholder="Search channels..."
        class="w-full p-2 rounded bg-gray-800 text-white focus:ring-2 focus:ring-blue-500 outline-none">
    </div>

    <!-- Channel List -->
    <div class="p-3 overflow-y-auto h-[calc(100%-7rem)]">
      <ul id="channelList" class="space-y-2 text-sm text-gray-300">
        <li class="text-center text-gray-500">Loading channels...</li>
      </ul>
    </div>
  </div>

  <!-- Your channels file MUST be before the logic below -->
  <script src="channels.js"></script>

  <script>
    jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';

    document.addEventListener("DOMContentLoaded", () => {
      const sidebar = document.getElementById("channelSidebar");
      const toggle = document.getElementById("channelToggle");
      const closeBtn = document.getElementById("closeSidebar");
      const list = document.getElementById("channelList");
      const searchInput = document.getElementById("searchInput");

      // Ensure channels are actually loaded
      function ensureChannels() {
        if (typeof window.channels === "undefined") {
          list.innerHTML = '<li class="text-center text-red-400">‚ùå channels.js not loaded</li>';
          return false;
        }
        if (Object.keys(window.channels).length === 0) {
          list.innerHTML = '<li class="text-center text-yellow-400">‚ö†Ô∏è No channels found in channels.js</li>';
          return false;
        }
        return true;
      }

      function populateChannelList() {
        if (!ensureChannels()) return;

        list.innerHTML = "";
        Object.keys(channels)
          .sort((a, b) => channels[a].name.localeCompare(channels[b].name))
          .forEach(key => {
            const li = document.createElement("li");
            li.className = "bg-gray-800 hover:bg-gray-700 cursor-pointer rounded-lg p-3 transition";
            li.textContent = channels[key].name;
            li.dataset.name = channels[key].name.toLowerCase();
            li.onclick = () => {
              loadStream(key);
              closeSidebar();
            };
            list.appendChild(li);
          });
      }

      function loadStream(key) {
        const ch = channels[key];
        if (!ch) return;

        jwplayer("player").setup({
          file: ch.url,
          type: ch.type,
          drm: ch.type === "mpd" ? {
            clearkey: { keyId: ch.keyId, key: ch.key }
          } : undefined,
          width: "100%",
          aspectratio: "16:9",
          autostart: true
        });
      }

      function closeSidebar() {
        sidebar.classList.add("translate-x-full");
      }

      toggle.onclick = () => sidebar.classList.remove("translate-x-full");
      closeBtn.onclick = closeSidebar;

      searchInput.addEventListener("input", () => {
        const query = searchInput.value.toLowerCase();
        document.querySelectorAll("#channelList li").forEach(li => {
          li.style.display = li.dataset.name?.includes(query) ? "block" : "none";
        });
      });

      // Try populating after small delay in case channels.js loads late
      setTimeout(populateChannelList, 500);
    });
  </script>

</body>
</html>
